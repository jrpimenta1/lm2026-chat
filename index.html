<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LM2026 | Bot Drive Transformation</title>

  <!-- Favicon -->
  <link rel="icon" href="/bot-icon.png" />

  <!-- Bot Framework Web Chat -->
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

  <style>
    :root{
      --primary:#0b6a77;
      --primary2:#0f8a9a;
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15, 23, 42, .10);
      --shadow: 0 18px 40px -5px rgba(0,0,0,.20), 0 15px 20px -5px rgba(0,0,0,.10);
      --radius: 18px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    }

    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(11,106,119,.18), transparent 60%),
        radial-gradient(900px 500px at 85% 30%, rgba(15,138,154,.14), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    .page{
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 18px;
      display: grid;
      grid-template-columns: 1fr 520px;
      gap: 22px;
      align-items: start;
    }

    .brandCard, .chatCard{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .brandInner{
      padding: 22px 22px 18px 22px;
    }

    .eventLogo{
      width: 260px;
      max-width: 100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      display:block;
      background:#fff;
      margin-bottom: 14px;
    }

    h1{
      margin: 14px 0 8px 0;
      font-size: 28px;
      line-height: 1.15;
      letter-spacing: .2px;
    }

    .subtitle{
      margin:0 0 16px 0;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.45;
    }

    .hint{
      margin-top: 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    /* Chat card */
    .chatHeader{
      height: 56px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 0 14px;
      background: var(--primary);
      color: #fff;
    }

    .chatTitle{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 700;
    }

    .chatTitle img{
  width: 22px;
  height: 22px;
  display: block;
  background: transparent !important;
  border-radius: 0 !important;
  padding: 0 !important;
    }

    .chatBody{
      height: 660px; /* desktop default */
      background:#fff;
    }

    #webchat{
      height: 100%;
    }

    /* Mobile */
    @media (max-width: 980px){
      .page{
        grid-template-columns: 1fr;
      }
      .chatBody{
        height: 70vh;
        min-height: 520px;
      }
    }

    @media (max-width: 520px){
      .brandInner{ padding: 18px; }
      .chatBody{ min-height: 520px; height: 72vh; }
      h1{ font-size: 24px; }
    }
  </style>
</head>

<body>
  <main class="page">
    <!-- LEFT: Landing -->
    <section class="brandCard">
      <div class="brandInner">
        <img class="eventLogo" src="/event-logo.png" alt="LM2026 - Driving Transformation" />

        <h1>LM2026 — Bot Drive Transformation</h1>

        <!-- One sentence only (PT or EN), set by JS -->
        <p class="subtitle" id="subtitle"></p>

        <!-- Examples (PT or EN), set by JS -->
        <div class="hint" id="examples"></div>
      </div>
    </section>

    <!-- RIGHT: Chat -->
    <section class="chatCard" id="chat-card">
      <div class="chatHeader">
        <div class="chatTitle">
          <img src="/bot-icon.png" alt="Bot icon" />
          Bot Drive Transformation
        </div>
      </div>
      <div class="chatBody">
        <div id="webchat" role="main"></div>
      </div>
    </section>
  </main>

  <script>
    // Token Endpoint (Copilot Studio → Web app channel → Token endpoint)
    const tokenEndpoint =
      "https://0f0a81529bbde17b958c1afc6ed2af.58.environment.api.powerplatform.com/powervirtualagents/botsbyschema/copilots_header_a2b4e/directline/token?api-version=2022-03-01-preview";

    // ---------- Language (single sentence based on browser language) ----------
    function isPT() {
      const lang = (navigator.language || navigator.userLanguage || "en").toLowerCase();
      return lang.startsWith("pt");
    }

    function setLandingText() {
      const pt = isPT();

      const subtitlePT =
        "Assistente do evento interno da SODECIA para apoiar participantes com informações sobre logística, agenda, contactos e conteúdos disponíveis na base de conhecimento do evento.";
      const subtitleEN =
        "Assistant for the SODECIA internal event to support participants with information about logistics, agenda, contacts and content available in the event's knowledge base.";

      const examplesPT =
        'Exemplos: <b>“Onde é o local?”</b>, <b>“Quem são os contactos?”</b>, <b>“Quais são as datas e horas?”</b>';
      const examplesEN =
        'Examples: <b>“Where is the venue?”</b>, <b>“Who are the contacts?”</b>, <b>“What are the key dates and times?”</b>';

      const subtitleEl = document.getElementById("subtitle");
      const examplesEl = document.getElementById("examples");

      if (subtitleEl) subtitleEl.textContent = pt ? subtitlePT : subtitleEN;
      if (examplesEl) examplesEl.innerHTML = pt ? examplesPT : examplesEN;
    }

    // ---------- WebChat ----------
    function showError(message) {
      const webchatEl = document.getElementById("webchat");
      if (!webchatEl) return;
      webchatEl.innerHTML =
        `<div style="padding:12px;font:14px system-ui;color:#b91c1c;">
          <b>WebChat error</b><br/>${message}
        </div>`;
    }

    async function initWebChat() {
      try {
        if (!window.WebChat) {
          throw new Error("WebChat library não carregou (verifica bloqueios de rede/proxy).");
        }

        const tokenUrl = new URL(tokenEndpoint);
        const apiVersion = tokenUrl.searchParams.get("api-version");
        const environmentEndPoint = tokenEndpoint.slice(0, tokenEndpoint.indexOf("/powervirtualagents"));

        if (!apiVersion || !environmentEndPoint.includes("environment.api.powerplatform.com")) {
          throw new Error("Token Endpoint inválido (api-version em falta ou domínio inesperado).");
        }

        // 1) Direct Line regional
        const regionalUrl = `${environmentEndPoint}/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`;
        const regionalResp = await fetch(regionalUrl);
        if (!regionalResp.ok) throw new Error(`regionalchannelsettings falhou: HTTP ${regionalResp.status}`);

        const regional = await regionalResp.json();
        const directLineBase = regional?.channelUrlsById?.directline;
        if (!directLineBase) throw new Error("regionalchannelsettings não devolveu channelUrlsById.directline");

        // 2) Token
        const tokenResp = await fetch(tokenEndpoint);
        if (!tokenResp.ok) throw new Error(`token endpoint falhou: HTTP ${tokenResp.status}`);

        const conversationInfo = await tokenResp.json();
        if (!conversationInfo.token) throw new Error("Resposta do token endpoint não contém 'token'.");

        // 3) Domínio final
        const directLineDomain = new URL("v3/directline", directLineBase).toString();

        // 4) Style options (ícone sempre visível)
        const styleOptions = {
          accent: "#0b6a77",
          botAvatarImage: `${window.location.origin}/bot-icon.png`,
          botAvatarInitials: "DT",
          userAvatarInitials: "U",
          showAvatarInGroup: true,
          avatarSize: 36,
          bubbleBorderRadius: 18,
          bubbleFromUserBorderRadius: 18
        };

        // 5) Enviar evento para disparar a saudação
        let greetingSent = false;
        const store = window.WebChat.createStore(
          {},
          () => next => action => {
            if (action.type === "DIRECT_LINE/CONNECT_FULFILLED" && !greetingSent) {
              greetingSent = true;
              store.dispatch({
                type: "WEB_CHAT/SEND_EVENT",
                payload: {
                  name: "startConversation",
                  value: { locale: navigator.language || "pt-PT" }
                }
              });
            }
            return next(action);
          }
        );

        const directLine = window.WebChat.createDirectLine({
          domain: directLineDomain,
          token: conversationInfo.token
        });

        window.WebChat.renderWebChat(
          {
            directLine,
            store,
            locale: navigator.language || "pt-PT",
            styleOptions
          },
          document.getElementById("webchat")
        );

        // foco no input
        setTimeout(() => {
          document.querySelector("#webchat input")?.focus();
        }, 450);

      } catch (e) {
        console.error(e);
        showError(String(e.message || e));
      }
    }

    window.addEventListener("load", () => {
      setLandingText();
      initWebChat();
    });
  </script>
</body>
</html>

