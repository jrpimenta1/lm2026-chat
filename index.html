<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LM2026 | Bot Drive Transformation</title>

  <link rel="icon" href="/bot-icon.png" />
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

  <style>
    :root{
      --primary:#0b6a77;
      --bg:#f4f6f8;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15, 23, 42, .10);
      --shadow: 0 18px 40px -5px rgba(0,0,0,.20), 0 15px 20px -5px rgba(0,0,0,.10);
      --radius: 18px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
    }

    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(11,106,119,.18), transparent 60%),
        radial-gradient(900px 500px at 85% 30%, rgba(15,138,154,.14), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    .page{
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 18px;
      display: grid;
      grid-template-columns: 1fr 520px;
      gap: 22px;
      align-items: start;
    }

    .brandCard, .chatCard{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .brandInner{
      padding: 22px 22px 18px 22px;
      text-align: left;
    }

    /* Centered event logo */
    .eventLogo{
      width: 320px;
      max-width: 100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      display:block;
      margin: 0 auto 14px auto;
      background: transparent;
    }

    h1{
      margin: 14px 0 10px 0;
      font-size: 28px;
      line-height: 1.15;
      letter-spacing: .2px;
    }

    .subtitle{
      margin:0 0 10px 0;
      color: var(--muted);
      font-size: 15px;
      line-height: 1.45;
    }

    .powered{
      margin:0 0 16px 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
      font-weight: 600;
    }

    .hint{
      margin-top: 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }

    /* Chat card */
    .chatHeader{
      height: 56px;
      display:flex;
      align-items:center;
      padding: 0 14px;
      background: var(--primary);
      color: #fff;
    }

    .chatTitle{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 700;
    }

    .chatTitle img{
      width: 22px;
      height: 22px;
      display: block;

      /* Contrast fix (Version 2): white badge + dark ring */
      padding: 6px;
      border-radius: 999px;
      background: #ffffff !important;
      border: 2px solid rgba(15, 23, 42, .55);
      box-shadow: 0 1px 6px rgba(0,0,0,.18);
      box-sizing: content-box;
    }

    .chatBody{
      height: 660px;
      background:#fff;
    }

    #webchat{ height: 100%; }
    #webchat, #webchat > * { height: 100% !important; }

    /* Remove extra top padding/margins if present */
    #webchat .webchat__basic-transcript,
    #webchat [class*="webchat__basic-transcript"],
    #webchat [class*="basic-transcript"]{
      padding-top: 0 !important;
      margin-top: 0 !important;
    }

    /* Mobile */
    @media (max-width: 980px){
      .page{ grid-template-columns: 1fr; }
      .chatBody{ height: 70vh; min-height: 520px; }
    }

    @media (max-width: 520px){
      .brandInner{ padding: 18px; }
      .chatBody{ min-height: 520px; height: 72vh; }
      h1{ font-size: 24px; }
    }
  
    /* Contrast fix (Version 2): bot avatar ring so it stands out on both teal header and white chat background */
    #webchat img[src*="bot-icon.png"]{
      border-radius: 999px !important;
      background: #ffffff !important;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, .45), 0 1px 6px rgba(0,0,0,.12);
    }

</style>
</head>

<body>
  <main class="page">
    <!-- LEFT: Landing -->
    <section class="brandCard">
      <div class="brandInner">
        <img class="eventLogo" src="/event-logo.png?v=2" alt="LM2026 - Event logo" />
        <h1>LM2026 — Bot Drive Transformation</h1>

        <!-- Portuguese first, then English (as requested) -->
        <p class="subtitle">
          Assistente do evento interno da SODECIA para apoiar participantes com informações sobre logística, agenda, contactos e conteúdos disponíveis na base de conhecimento do evento.
        </p>
        <p class="subtitle">
          Assistant for the SODECIA internal event to support participants with information about logistics, agenda, contacts and content available in the event's knowledge base.
        </p>

        <p class="powered">Powered by AI SODECIA Lab.</p>

        <div class="hint">
          Exemplos / Examples:
          <b>“Onde é o local?”</b>,
          <b>“Quem são os contactos?”</b>,
          <b>“Quais são as datas e horas?”</b>,
          <b>“Where is the venue?”</b>,
          <b>“Who are the contacts?”</b>,
          <b>“What are the key dates and times?”</b>,
          <b>“Which are transfers for the event?”</b>,
          <b>“Which are the BUS sitting definitions?”</b>,
          etc.
        </div>
      </div>
    </section>

    <!-- RIGHT: Chat -->
    <section class="chatCard">
      <div class="chatHeader">
        <div class="chatTitle">
          <img src="/bot-icon.png?v=2" alt="Bot icon" />
          Bot Drive Transformation
        </div>
      </div>
      <div class="chatBody">
        <div id="webchat" role="main"></div>
      </div>
    </section>
  </main>

  <script>
    // Token Endpoint (Copilot Studio → Web app channel → Token endpoint)
    const tokenEndpoint =
      "https://0f0a81529bbde17b958c1afc6ed2af.58.environment.api.powerplatform.com/powervirtualagents/botsbyschema/copilots_header_a2b4e/directline/token?api-version=2022-03-01-preview";

    // -------- Robust “hybrid” transcript fix (reduces big blank space on top) --------

    function getScrollableCandidates(root) {
      const nodes = Array.from(root.querySelectorAll("*"));
      return nodes.filter(el => {
        const cs = getComputedStyle(el);
        const oy = (cs.overflowY || "").toLowerCase();
        return (oy === "auto" || oy === "scroll") && el.clientHeight > 80;
      });
    }

    function pickScroller(root) {
      const candidates = getScrollableCandidates(root);
      candidates.sort((a,b) => (b.clientHeight || 0) - (a.clientHeight || 0));
      return candidates[0] || null;
    }

    function forceTopAlignmentOnAllFlexEndColumns(root) {
      const nodes = Array.from(root.querySelectorAll("*"));
      for (const el of nodes) {
        const cs = getComputedStyle(el);
        if (cs.display !== "flex") continue;
        if ((cs.flexDirection || "").toLowerCase() !== "column") continue;
        if ((cs.justifyContent || "").toLowerCase() !== "flex-end") continue;

        el.style.setProperty("justify-content", "flex-start", "important");
        el.style.setProperty("align-content", "flex-start", "important");
      }
    }

    let rafLock = false;

    function applyHybrid() {
      if (rafLock) return;
      rafLock = true;

      requestAnimationFrame(() => {
        rafLock = false;

        const root = document.getElementById("webchat");
        if (!root) return;

        forceTopAlignmentOnAllFlexEndColumns(root);

        const scroller = pickScroller(root);
        if (!scroller) return;

        const hasOverflow = scroller.scrollHeight > (scroller.clientHeight + 6);

        if (!hasOverflow) {
          scroller.scrollTop = 0;
        } else {
          scroller.scrollTop = scroller.scrollHeight;
        }
      });
    }

    function installObserver() {
      const root = document.getElementById("webchat");
      if (!root) return;

      const obs = new MutationObserver(() => {
        applyHybrid();
        requestAnimationFrame(applyHybrid);
        setTimeout(applyHybrid, 120);
      });

      obs.observe(root, { childList: true, subtree: true });

      window.addEventListener("resize", () => setTimeout(applyHybrid, 120));

      setTimeout(() => {
        applyHybrid();
        requestAnimationFrame(applyHybrid);
        setTimeout(applyHybrid, 600);
      }, 900);
    }

    // -------- WebChat init --------

    function showError(message) {
      const webchatEl = document.getElementById("webchat");
      if (!webchatEl) return;
      webchatEl.innerHTML =
        `<div style="padding:12px;font:14px system-ui;color:#b91c1c;">
          <b>WebChat error</b><br/>${message}
        </div>`;
    }

    async function initWebChat() {
      try {
        if (!window.WebChat) throw new Error("WebChat library did not load.");

        const tokenUrl = new URL(tokenEndpoint);
        const apiVersion = tokenUrl.searchParams.get("api-version");
        const environmentEndPoint = tokenEndpoint.slice(0, tokenEndpoint.indexOf("/powervirtualagents"));

        // 1) Direct Line regional URL
        const regionalUrl = `${environmentEndPoint}/powervirtualagents/regionalchannelsettings?api-version=${apiVersion}`;
        const regionalResp = await fetch(regionalUrl);
        if (!regionalResp.ok) throw new Error(`regionalchannelsettings failed: HTTP ${regionalResp.status}`);
        const regional = await regionalResp.json();

        const directLineBase = regional?.channelUrlsById?.directline;
        if (!directLineBase) throw new Error("regionalchannelsettings did not return channelUrlsById.directline");

        // 2) Token
        const tokenResp = await fetch(tokenEndpoint);
        if (!tokenResp.ok) throw new Error(`token endpoint failed: HTTP ${tokenResp.status}`);
        const conversationInfo = await tokenResp.json();
        if (!conversationInfo.token) throw new Error("Token response missing 'token'.");

        // 3) Final domain
        const directLineDomain = new URL("v3/directline", directLineBase).toString();

        // 4) Style options (bot icon)
        const styleOptions = {
          accent: "#0b6a77",
          botAvatarImage: `${window.location.origin}/bot-icon.png?v=2`,
          botAvatarInitials: "DT",
          userAvatarInitials: "U",
          showAvatarInGroup: true,
          avatarSize: 36,
          bubbleBorderRadius: 18,
          bubbleFromUserBorderRadius: 18
        };

        // 5) Send event to trigger greeting
        let greetingSent = false;

        const store = window.WebChat.createStore(
          {},
          () => next => action => {
            const result = next(action);

            if (action.type === "DIRECT_LINE/CONNECT_FULFILLED" && !greetingSent) {
              greetingSent = true;
              store.dispatch({
                type: "WEB_CHAT/SEND_EVENT",
                payload: {
                  name: "startConversation",
                  value: { locale: navigator.language || "en-US" }
                }
              });
            }

            if (
              action.type === "DIRECT_LINE/INCOMING_ACTIVITY" ||
              action.type === "DIRECT_LINE/POST_ACTIVITY_FULFILLED" ||
              action.type === "DIRECT_LINE/CONNECT_FULFILLED"
            ) {
              setTimeout(applyHybrid, 150);
              requestAnimationFrame(applyHybrid);
            }

            return result;
          }
        );

        const directLine = window.WebChat.createDirectLine({
          domain: directLineDomain,
          token: conversationInfo.token
        });

        window.WebChat.renderWebChat(
          {
            directLine,
            store,
            locale: navigator.language || "en-US",
            styleOptions
          },
          document.getElementById("webchat")
        );

        installObserver();

        setTimeout(() => {
          document.querySelector("#webchat input")?.focus();
          applyHybrid();
        }, 1100);

      } catch (e) {
        console.error(e);
        showError(String(e.message || e));
      }
    }

    window.addEventListener("load", () => {
      initWebChat();
    });
  </script>
</body>
</html>
